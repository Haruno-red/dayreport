= Kubernetes（続き）

== Deploymentとは
* Podとそれを管理するReplicaSetを管理する。
* ReplicaSetの機能に加え、ローリングアップデートやロールバックなどのアップデート機能を提供。

==== 主な機能
* ReplicaSetのロールアウト（更新）: 新しいReplicaSetを作成して古いReplicaSetを削除する。
* 前のバージョンへロールバック（戻す）: 不安定な場合に対処する。
* スケールアップ・ダウン : ReplicaSetのレプリカ数を変更する。

==== Deployment特有のフィールド
[options="header"]
|======
|フィールド　|意味　|詳細
|strategy　|更新戦略　|Recreate（過去のすべてのPodを削除して更新） か RollingUpdate（少しずつPodを削除しながら更新） を指定。 +
デフォルトは Recreate
|revisionHistory　|バージョンを残しておく数　|過去のReplicaSetをいくつ残しておくかを指定。 +
デフォルトは10
|paused　|一時停止　|ロールアウトを明示的に一時停止する。 +
普段はあまり使わない。
|progressDeadlineSeconds　|　|更新プログレスの最大秒数を示す。 +
デフォルトは600秒
|======

==== Deploymentの流れ
. Deploymentを作成して適用する。
. APIサーバを通してDeploymentオブジェクトが作成される。
. controller-managerの中のDeployment-controllerでDeploymentオブジェクトを常に監視。
. ReplicaSetオブジェクトが作成され、ReplicaSet-controllerによりPodも作成される。
. [red]#Deploymentのイメージを更新する。#
. 新しいReplicaSetオブジェクトを作成し、古いレプリカ数を減らし、新しいレプリカ数を増やすことで、Podの増減を図る。
. レプリカ数の変更に伴い、古いPodが削除され、新しいPodが作成される。

== Jobとは
* 一度のタスクを実行するために提供されているオブジェクト。
* １つ以上のPodを作成し、指定された数のPodが正常終了するまでPodを実行し続け、開始から完了までを保証する役割を持っている。

== Jobの並列実行

==== Jobの３種類の実行方法
. 非並列Job : １つのPodのみを起動し、実行する。
. 固定回数の並列Job : 同時実行するPodの数を制御しながら起動し、指定した回数分のPodを実行する。
. ワークキューを使用した並列Job : 同時実行するPodの数を指定し、メッセージキューからタスクを取得して実行する。

==== 並列実行のユースケース
データの並列処理 :: 大量のデータを複数のPodで並列に処理することで、処理時間の短縮になる。
バッチ処理の高速化 :: 定期的なバッチ処理を並列実行することで、システム全体の効率向上に繋がる。
分散タスクの実行 :: タスクをメッセージキューに分散し複数のPodで並列に処理することで、拡張的なシステムを構築できる。

==== Jobの終了とクリーンアップ
* Jobが完了するとそれ以上Podは作成されないが、削除されることもない。
* Podを残しておくと完了したPodのログを確認でき、エラーや警告などの診断出力を確認できる。
* Jobオブジェクトも残っているため、状態を確認することもできる。
* 終了したJobを残ったままにしておくとAPIサーバに負担をかけるので、削除しておくのが好ましい。
* Jobを削除する場合、Podも全部削除される。
* Jobの活動期間を設定することでも、Jobを終了させることができる。

== ConfigMap（設定用リソース）
* 機密性のないデータ（設定）をキーと値のペアで保存しておくAPIオブジェクト。Podも使うことができる。
* コンテナイメージと環境固有の設定を切り離すことができ、アプリケーションがポータブルに運用できる。 +
※同じアプリケーションでもテスト用と本番用のように異なる環境で実行できる。
* confファイルで読み込めば、設定も環境ごとに変えられる。

==== 主な使用方法
* コンテナの環境変数で読み込み先等を設定する。
* 読み込み専用のvolumeの作成で、アプリケーション側から読み込めるようにする。

== Secret（設定用リソース）
* 機密情報（パスワード、トークン、SSHキー等）を保存・管理するAPIオブジェクト。
* エンコードされたパスキーが必要となる。

==== 主な使用方法
* volumeのファイルとして、Pod内のコンテナにマウントする。
* コンテナの環境変数を設定する。
* kubeletがDockerイメージをpullする際に使用する。
