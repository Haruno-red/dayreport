= Kubenetes

== kubectlの構文
[source,bash]
----
kubectl [command] [TYPE] [NAME] [flags]
----
==== 詳細
|=======================
|command　|実行したい操作（get、create、patch等）
|TYPE　|リソースタイプ（pod、node、service等）
|NAME　|リソース名
|flags　|オプションのflag（--kubeconfig等）
|=======================

== APIのリソースタイプ
==== 一覧を表するコマンド
[source,bash]
----
kubectl api-resources
----
==== 一覧で表示される項目
[options="header"]
|=======================
|項目　|意味
|NAME　|リソース名（ローマ字小文字、複数形）
|SHORTNAMES　|リソースの短縮形（例 : po、sa）
|APIGROUP　|APIグループ（リソースをまとめて管理するグループ）
|NAMESPACED　|名前空間（後述）に属するか
|KIND　|リソースの種類（NAMEの単数形、キャメルケース）
|=======================

== Podとは
* Kubernetes上のデプロイの最小単位。

==== 特徴
. １つまたは複数のコンテナを持つ。
  .. Podが使えなくなった場合に他のノードにデプロイされることもある。
  .. 一つのアプリケーションを複数のPodでデプロイすることが多い。
  .. 複数のアプリケーションを一つのPodに入れない。
  .. 個別のPodを直接操作しない。（ワークロードリソースにPodを管理してもらう。）
. ネットワークやストレージを共有リソースとして持つ。
  .. 同じストレージにアクセスできる。
  .. IPアドレスとポートを含むネットワーク名前空間を共有。localhostで通信できる。
. コンテナの実行方法に関する仕様を持つ。

== オブジェクトとは
* クラスタの状態を表現する。
* クラスタ内に存在し、アプリケーションのデータや設定を保持するためのリソースで、データの永続性を保持する。

==== オブジェクトの２つのフィールド
[options="header"]
|=======================
|フィールド　|意味　|変更方法
|spec　|理想状態（desired state）　|kubectlやプログラムにより変更する。
|status　|現実状態（current state）　|Kubernetesにより更新される。
|=======================

==== オブジェクトの操作
* kubernetesAPIにkubectlコマンドを送る。プログラムによる操作も可能。

==== Kubernetesオブジェクトの管理方法
命令型コマンド（開発用） :: クラスタ内の現行のオブジェクトに対して直接処理を行う。
命令型オブジェクト設定（本番用） :: kubectlコマンドに処理内容、フラグ、最低１つのファイル名を指定する。ファイルが対象。
宣言型オブジェクト設定（本番用） :: ローカルに置いてある設定ファイルを操作し、操作内容は指定しない。ディレクトリが対象。

※同じオブジェクトには、一つの手法で管理をすることに注意。

== Namespace（名前空間）とは
* 同一の物理クラスタ上で動作する各仮想クラスタのこと。（一つのクラスタを論理的に分けて使うため。）
* 特定の目的やチーム、環境ごとに切り分ける使い方が一般的。

==== 初期Namespace
    default :: デフォルト。指定しない場合にオブジェクトが作成されるNamespace。
    kube-system :: Kubernetesのシステムによって作成されたオブジェクトのためのNamespace。
    kube-public :: 認証されていないユーザを含むすべてのユーザが読み取り可のNamespace。
    kube-node-lease :: ノードのハードウェアのパフォーマンス向上のためのLeaseオブジェクトのNamespace。

==== Namespaceを分けることのメリット
* 各Namespaceで制限を変えて設定が可能。
* Podやコンテナのリソースの範囲を設定できる。（メモリやCPUのストレージの限度、デフォルト等）
* Namespace全体の総リソースの制限ができる。（メモリやCPUの合計の限度、Podやオブジェクト数の限度等）
* 権限の管理ができる。（特定のNamespaceごとに権限を付与）

== ワークロードリソースとは
* 複数のPodを作成・管理するためのリソース。

例 : ReplicaSet、Deployment、DeamonSet、CronJob等

== ReplicaSet（ワークロードリソースの一つ）
* 常に指定したレプリカ数のPodを保つ役割を持つ。
* 数を保証してくれるだけで、新しいPodに入れ替える作業はしてくれない（バージョンが新しくなった時に更新してくれない）ため、直接使用することはほとんどない。 +
→Deploymetというリソースが奨励されている。
==== 入っている情報
|=======================
|replicas　|稼働させたいPodの数
|templates　|Podを作成するときのテンプレート
|selector　|対象となるPodの特定
|=======================

==== ReplicaSetの流れ
. APIサーバを通してReplicaSetを作成。
. contoller-managerの中のReolicaSet-managerでReplicaオブジェクトを常に監視。
. 指定されたレプリカ数とPodの数が同じになるように増減を調整。

== その他（参考）
https://kubernetes.io/ja/docs/reference/kubectl/[kubectlの構文やオプションの詳細]
